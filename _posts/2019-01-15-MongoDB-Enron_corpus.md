---
title: "Intro to MongoDB: Enron emails data "
categories:
  - data wrangling
tags:
  - data wrangling
  - NoSQL
  - MongoDB
---

# Intro to MongoDB: Enron emails data 

The purpose of this exercise is to get more familiar with MongoDB Database and pymongo client, NoSQL data modeling.

## Data :
[The Enron Corpus](https://www.cs.cmu.edu/~./enron/) is a large database of over 600,000 emails generated by 158 employees of the Enron Corporation and acquired by the Federal Energy Regulatory Commission during its investigation after the company's collapse.
For the purpose of this exercise we are only using a subset of the dataset containing 1702 emails and annotation


## Goals:

 I am looking to answer the following questions about the enron email messages:

- How many emails did each person receive each day?  

- Let's label an email as "direct" if there is exactly one recipient and "broadcast" if it has multiple recipients. Identify the person (or people) who received the largest number of direct emails and the person (or people) who sent the largest number of broadcast emails.  


## ETL : 
## Raw data analysis 

File structure : 
```
../data/enron_with_categories/X/files.txt
```

Email is MIME format :

```
Message-ID: <3688931.1075846177364.JavaMail.evans@thyme>

Date: Wed, 27 Sep 2000 10:33:00 -0700 (PDT)

From: steven.kean@enron.com

To: miyung.buster@enron.com, elizabeth.linnell@enron.com

Subject: Message Points on Higher Gas Prices

Mime-Version: 1.0

Content-Type: text/plain; charset=us-ascii

Content-Transfer-Encoding: 7bit

X-From: Steven J Kean

X-To: Miyung Buster, Elizabeth Linnell

X-cc: X-bcc: X-Folder: \Steven_Kean_Dec2000_1\Notes Folders\All documents X-Origin: KEAN-S X-FileName: skean.nsf

Please pst and circulate to the team. We probably need to open a new section on the site to adress gas prices. ----- Forwarded by Steven J Kean/NA/Enron on 09/27/2000 05:32 PM -----

Shelley Corman
09/07/2000 05:34 PM

     To: Richard Shapiro/HOU/EES@EES, Steven J Kean/NA/Enron@Enron, James D 
Steffes/HOU/EES@EES, Rob Bradley/Corp/Enron@ENRON, Margaret Carson/Corp/Enron@ENRON cc: Subject: Message Points on Higher Gas Prices
```

Notes:   
* Every emails won't have all headers, some field are necessary ie: From, Date, Mime-Version. Others fields are optional ie: To , CC, Bcc, X- fields. 

* To answer the questions we do not need to focus on the body of the emails only the header suffice
* All emails will not necessarily have the same headers fields, some might be missing like To , Cc, Bcc

A document data model seems like the best option for flexibility
My data model is : 

```json
{'UTC': 976791060,
 'bcc': {'email': ['dale.clark@enron.com',
                   ' jennifer.medcalf@enron.com',
                   ' patrick.tucker@enron.com',
                   ' peter.goebel@enron.com'],
         'name': ['']},
 'cc': {'email': ['dale.clark@enron.com',
                  ' jennifer.medcalf@enron.com',
                  ' patrick.tucker@enron.com',
                  ' peter.goebel@enron.com'],
        'name': ['Dale Clark',
                 ' Jennifer Medcalf',
                 ' Patrick Tucker',
                 ' Peter Goebel']},
 'from': {'email': 'matt.harris@enron.com', 'name': 'Matt Harris'},
 'label': 'broadcast',
 'local_date': '2000-12-14',
 'msg_datetime': 'Thu, 14 Dec 2000 02:51:00 -0800 (PST)',
 'msg_id': '<860767.1075849626951.JavaMail.evans@thyme>',
 'recipients': ['sarah-joy.hunter@enron.com',
                ' jennifer.medcalf@enron.com',
                'dale.clark@enron.com',
                ' peter.goebel@enron.com',
                ' patrick.tucker@enron.com'],
 'recipients_cnt': 5,
 'subject': 'Re: HP -- confidential internal document',
 'to': {'email': ['sarah-joy.hunter@enron.com'], 'name': ['Sarah-Joy Hunter']}}

```
Code for parsing is available [here](path_to_notebook)

## MongoDB
Mongo DB is a convenient NoSQL database which uses JSON syntax to store and query documents. I used MongoDB has a wanted to leverage the flexibility of document format (JSON) to help navigate the email markup .

### Load data to MongoDB
#### Create a MongoClient
```python 
from pymongo import MongoClient
client = MongoClient(host='localhost', port=27017, serverSelectionTimeoutMS=20000)
enrondb = client['enron']
email_headers = enrondb['headers']
```

#### Import data into the database
```python
email_headers.remove() #clearing collection
result = email_headers.insert_many(headers_all)
```

#### Check if you have results
```python 
pp.pprint(email_headers.find_one())
```

```json
{'UTC': 965116500,
 '_id': ObjectId('5c6b2edc6a0c4b9d2508c7c3'),
 'bcc': {'email': [''], 'name': ['']},
 'cc': {'email': [''], 'name': ['']},
 'from': {'email': 'steven.kean@enron.com', 'name': 'Steven J Kean'},
 'label': 'direct',
 'local_date': '2000-08-01',
 'msg_datetime': 'Tue, 1 Aug 2000 00:55:00 -0700 (PDT)',
 'msg_id': '<20902759.1075846162054.JavaMail.evans@thyme>',
 'recipients': ['maureen.mcvicker@enron.com'],
 'recipients_cnt': 1,
 'subject': 'Welcome New Associates - Reception',
 'to': {'email': ['maureen.mcvicker@enron.com'], 'name': ['Maureen McVicker']}}
```

##Do some analysisÂ¶

- How many emails did each person receive each day?

```python
def make_pipeline():
    pipeline = [
        { "$unwind" : "$recipients" },
        { "$group" : { "_id" : { "recipients":"$recipients","date":"$local_date"},
                       "count": { "$sum" : 1 }}},
        { "$sort" : {"count":-1}},
        {"$limit":10}
    ]
    
    return pipeline


pipeline = make_pipeline()

aggResult = email_headers.aggregate(pipeline)
for cur in aggResult:
    print(cur["_id"]["date"],cur["_id"]["recipients"],cur["count"])
```

```json
2001-02-28 bernadette.hawkins@enron.com 17
2001-06-26 vkaminski@aol.com 10
2001-06-06  mark.palmer@enron.com 9
2001-06-06  james.steffes@enron.com 9
2001-06-06  susan.mara@enron.com 9
2001-06-06  jeff.dasovich@enron.com 9
2001-06-06  sandra.mccubbin@enron.com 7
2001-06-06  marcus.dotson@enron.com 7
2001-06-06  chris.holmes@enron.com 7
2001-06-06  rob.bradley@enron.com 7
```

Let's label an email as "direct" if there is exactly one recipient and "broadcast" if it has multiple recipients    
-  Identify the person (or people) who received the largest number of direct emails

```python
def make_pipeline():
    pipeline = [
        {"$match" : {"label":"direct"}},
        { "$unwind" : "$recipients" },
        { "$group" : { "_id" :  "$recipients",
                       "count": { "$sum" : 1 }}},
        { "$sort" : {"count":-1}},
        {"$limit":10}
    ]
    
    return pipeline


pipeline = make_pipeline()

aggResult = email_headers.aggregate(pipeline)
pp.pprint(list(aggResult))
```

```
[{'_id': 'maureen.mcvicker@enron.com', 'count': 115},
 {'_id': 'vkaminski@aol.com', 'count': 43},
 {'_id': 'jeff.dasovich@enron.com', 'count': 25},
 {'_id': 'richard.shapiro@enron.com', 'count': 23},
 {'_id': 'elizabeth.linnell@enron.com', 'count': 18},
 {'_id': 'bernadette.hawkins@enron.com', 'count': 17},
 {'_id': 'shirley.crenshaw@enron.com', 'count': 16},
 {'_id': 'linda.robertson@enron.com', 'count': 15},
 {'_id': 'karen.denne@enron.com', 'count': 14},
 {'_id': 'rosalee.fleming@enron.com', 'count': 11}]
```
 


- Identify the person (or people) who sent the largest number of broadcast emails.

```python
def make_pipeline():
    pipeline = [
        {"$match" : {"label":"broadcast"}},
        { "$group" : { "_id" :  "$from.email",
                       "count": { "$sum" : 1 }}},
        { "$sort" : {"count":-1}},
        {"$limit":10}
    ]
    
    return pipeline


pipeline = make_pipeline()

aggResult = email_headers.aggregate(pipeline)
pp.pprint(list(aggResult))
```

```json
[{'_id': 'steven.kean@enron.com', 'count': 383},
 {'_id': 'john.shelk@enron.com', 'count': 83},
 {'_id': 'j.kaminski@enron.com', 'count': 45},
 {'_id': 'miyung.buster@enron.com', 'count': 31},
 {'_id': 'alan.comnes@enron.com', 'count': 19},
 {'_id': 'kevinscott@onlinemailbox.net', 'count': 15},
 {'_id': 'legalonline-compliance@enron.com', 'count': 14},
 {'_id': 'susan.mara@enron.com', 'count': 11},
 {'_id': 'jmunoz@mcnallytemple.com', 'count': 11},
 {'_id': 'michelle.cash@enron.com', 'count': 10}]
```


